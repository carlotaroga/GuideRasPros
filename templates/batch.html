{% extends "base.html" %}

{% block title %}USpeakPy Web - Batch Simulation{% endblock %}

<!-- Block for specific CSS for each page -->
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/batch.css') }}">
{% endblock %}

{% block content %}
<h1>Process a File</h1> 
<!-- First form: file upload and processing -->
<form id="processForm" enctype="multipart/form-data">
    <h2>Upload and Process File</h2>

    <!-- File format -->
    <div class="form-group">
        <label>Input file format:</label>
        <label><input type="radio" name="file_format" value="CSV" required onchange="toggleExcelSheet()"> CSV</label>
        <label><input type="radio" name="file_format" value="Excel" required onchange="toggleExcelSheet()"> Excel</label>
    </div>

    <!-- File selection -->
    <div class="form-group">
        <label for="inputFile">Input file:</label>
        <input type="file" id="inputFile" name="input_file" required>
    </div>

    <!-- Sheet name field (only visible if Excel is selected) -->
    <div class="form-group" id="excelSheetField" style="display: none;">
        <label for="excelSheet">Excel sheet:</label>
        <input type="text" id="excelSheet" name="excel_sheet">
    </div>

    <div class="form-group">
        <button type="submit" id="submitBtn" onclick="uploadFile(event)">Submit</button>
    </div>

    <!-- Download results button (initially disabled) -->
    <div class="form-group">
        <button type="button" id="downloadBtn" disabled onclick="downloadResults()">Download results</button>
    </div>
</form>

<script>
    // Displays Excel sheet field only if Excel format is selected
    function toggleExcelSheet() {
        const excelSheetField = document.getElementById('excelSheetField');
        const fileFormat = document.querySelector('input[name="file_format"]:checked').value;
        excelSheetField.style.display = (fileFormat === 'Excel') ? 'block' : 'none';
    }

    // Enable the download button for results when they are ready
    function enableDownloadButton() {
        document.getElementById('downloadBtn').disabled = false;
    }

    // Example of function to simulate file availability
    function downloadResults() {
        alert("El archivo de resultados está listo para descargar.");
    }

    // Validate the file extension before submitting the form
    async function uploadFile(event) {
        // Obtener elementos del formulario
        const form = document.getElementById('processForm');
        const formData = new FormData(form);
        const inputFile = document.getElementById('inputFile').files[0];
        const fileFormat = document.querySelector('input[name="file_format"]:checked').value;

        // Adding data to FormData
        formData.append('file_format', fileFormat);
        formData.append('input_file', inputFile);
        
        // Get the file extension
        const fileExtension = inputFile.name.split('.').pop().toLowerCase();

        // Check if the extension is valid according to the selected format
        if (fileFormat === 'CSV' && fileExtension !== 'csv') {
            alert("Por favor, selecciona un archivo con extensión .csv");
            event.preventDefault(); 
            return false;
        }

        if (fileFormat === 'Excel' && fileExtension !== 'xlsx') {
            alert("Por favor, selecciona un archivo con extensión .xlsx");
            event.preventDefault(); 
            return false;
        }

         // Performing the POST with fetch
         try {
            const response = await fetch('/upload_file', {
                method: 'POST',
                body: formData
            });

            // Response management
            if (response.ok) {
                const result = await response.text();
                alert('Archivo subido correctamente: ' + result);
            } else {
                alert('Error al subir el archivo.');
            }
        } catch (error) {
            console.error('Error en la solicitud:', error);
            alert('Error en la solicitud: ' + error.message);
        }
    }
</script>

{% endblock %}
